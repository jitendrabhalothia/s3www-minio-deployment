version: '3'

tasks:
  setup-secrets:
    desc: Install Sealed Secrets controller and seal MinIO credentials
    cmds:
      - echo "🔧 Checking if Sealed Secrets controller is installed..."
      - |
        if ! helm list -n kube-system | grep sealed-secrets > /dev/null; then
          helm repo add bitnami-labs https://bitnami-labs.github.io/sealed-secrets
          helm repo update
          helm install sealed-secrets bitnami-labs/sealed-secrets --namespace kube-system
        else
          echo "✅ Sealed Secrets controller already installed."
        fi
      - echo "⏳ Waiting for sealed-secrets controller to be ready..."
      - |
        kubectl wait --namespace kube-system \
          --for=condition=Available deployment/sealed-secrets \
          --timeout=90s
      - echo "🔐 Creating and sealing MinIO credentials..."
      - |
        kubectl create secret generic minio-creds \
          --from-literal=accesskey=minioadmin \
          --from-literal=secretkey=minioadmin \
          --dry-run=client -o yaml > minio-creds.yaml
      - |
        kubeseal \
          --controller-name=sealed-secrets \
          --controller-namespace=kube-system \
          --format yaml < minio-creds.yaml > charts/s3www/files/minio-sealed-secret.yaml
      - rm -f minio-creds.yaml
      - echo "✅ Sealed secret created at charts/s3www/files/minio-sealed-secret.yaml"
      - echo "📦 Applying sealed secret..."
      - kubectl apply -f charts/s3www/files/minio-sealed-secret.yaml

  destroy-secrets:
    desc: Uninstall sealed-secrets controller and delete sealed secrets
    cmds:
      - echo "🔥 Deleting sealed-secrets secret and controller..."
      - kubectl delete -f charts/s3www/files/minio-sealed-secret.yaml || true
      - helm uninstall sealed-secrets -n kube-system || true
      - echo "✅ Sealed Secrets cleanup complete."
