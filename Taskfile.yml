version: '3'

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  terraform-deploy:
    desc: ðŸ›  Deploy infrastructure using Terraform
    dir: terraform
    cmds:
      - echo "ðŸš€ Initializing Terraform..."
      - terraform init
      - echo "âœ… Terraform initialized!"
      - echo "ðŸ“¦ Applying Terraform..."
      - terraform apply -auto-approve
      - echo "âœ… Terraform apply complete!"

  terraform-destroy:
    desc: ðŸ§¹ Destroy infrastructure with Terraform
    dir: terraform
    cmds:
      - echo "ðŸ§¨ Destroying all resources..."
      - terraform destroy -auto-approve
      - echo "ðŸ§¼ All resources destroyed."

  open-app:
    desc: ðŸŒ Open s3www NodePort URL in browser
    cmds:
      - |
        echo "ðŸŒ Trying to open the s3www URL..."
        PORT=$(kubectl get svc s3www -n s3www-app -o=jsonpath='{.spec.ports[0].nodePort}')
        echo "âž¡ http://localhost:$PORT"
        if command -v xdg-open > /dev/null; then
          xdg-open http://localhost:$PORT
        elif command -v open > /dev/null; then
          open http://localhost:$PORT
        else
          echo "Please open http://localhost:$PORT manually."
        fi

  status:
    desc: ðŸ“‹ Show Kubernetes pods and services
    cmds:
      - kubectl get pods -n s3www-app
      - kubectl get svc -n s3www-app

  setup:
    desc: ðŸ”§ Full setup pipeline (Terraform + Sealed Secrets + Open URL)
    deps: [terraform-deploy, status, open-app]
